--- 
title: "R_http-API_client_1"
author: "Benjamin DAUTRIF"
date: "2023-10-27"
output:
  html_document:
    df_print: paged
---

# Summary 

This script installs from the *"configuration shunk"* the *"httr2"* package. All interogations of the HDX database relies on it. 

For more informations, see :                                    
https://httr2.r-lib.org/                                    
https://cran.r-project.org/web/packages/httr2/                                    

URL of the reliefWeb API :                                    
https://apidoc.rwlabs.org/                                    

Code for parametric search is largely inspired form "Disastr.api" ; wrapper for the UN OCHA ReliefWeb Disaster Events API. Adaptation done to adapte for other ENDPOINTS (see below, eg. "reports").


```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

# Packages installation 
# install.packages("httr2")
# install.packages("rjson")

# Load the package required to http protocole management.
library("httr2")
# Load the package required to read JSON files.
library("rjson")
```

# Variables definition :

*"Endpoint"* defines the type of documents (eg, reports, job annonce, disaster event....). *"parameters"* are then given to search for words in specific fields ; some being specific to certain *endpoints*.      

For more information on parameters, see [API documentation]("https://apidoc.rwlabs.org/parameters")

# Client 

3 functions :    

**1.** : calls API url and defines *"endpoint"*

```{r REQUEST, echo=TRUE}
req_call <- function(var_endpoint){
  endpoints = c(
    "reports",
    "disasters",
    "countries",
    "jobs",
    "training",
    "sources",
    "blog",
    "book"
  )
  req = request("https://api.reliefweb.int/v1/")
  req = req_url_path_append(req, endpoints[var_endpoint])
  req$url = paste0(req$url,"?appname=R_HDX_client_2")
  
  return(req)
}
```

Returns a REQUEST which is to enrich with *"parameters"*. 

**2.** Summaryze results :

Beware of parentheses in multi-arguments calls for URL management seek.

```{r SUMMARY,echo=TRUE}
res_summary <- function(res, field, lim = 100){
# - input : { Resultat after JSon extract [res] ; The field to print in final list [field]}
# - output : a list of fields from objects extracted by [res]

# SUMMARY (depending on types as ENDPOINT, due to different API structures ; see API) : 
  # Example :
  # - endpoint = 1 -> reports -> title
  # - endpoint = 2 -> disasters -> name
  
fields = c(
    "title", # reports
    "name",  # disasters
    "name",  # "countries",
    "title", # "jobs",
    "title", # "training",
    "name",  # "sources",
    "title", # "blog",
    "title"  # "book",
  )
eval(parse(text = paste("
for(i in seq(1,lim)){
print(paste0(i,\" -> \",res$data[i][[1]]$fields$",fields[field],"))}",sep="")))
}
```

**3.** Get specific FIELD in specific resource and see on web :

```{r COLLECT,echo=TRUE}
COLLECT_SEARCH = function(res) {
  # Objectif : print a summary according to given FIELD
  # Input : a result-pool 
  # Output : LIST of fields for all pool
  # PRINT MENUE :
  title_list = lapply(res$data, function(x) {
    print(x$fields)
  })
  print(title_list)
  # KEYBOARD ENTRY :
  # - CHOOSE resource :
  y = as.numeric(readline("Choose ressource to view on web : \n"))
  # - CHOOSE field (see.....) :
  field = readline("Choose a field to view : \n")
  # - OPTIONAL web-page :
  web_page = readline("Do you want to open web-page (Y/N) : \n")
  # LIST FIELDS in the pool :
  result = eval(parse(text = paste0("res$data[[", y, "]]$", field)))
  # WEB PAGE :
  if (web_page == "Y" |
      web_page == "y") {
    web_page_url = res$data[[y]]$href
    browseURL(url = web_page_url)
  }
  # RETURN the field-list 
  return(result)
}
```

```{r PRINT,echo=TRUE}
PRINT_SEARCH = function(res,
                        numero,
                        namefile,
                        txt = NULL,
                        html = NULL,
                        pdf = NULL) {
  
  # Menu results : 
  lapply(res$data,function(x){x$fields$name})
  
  # Request URL :
  url = res$data[[numero]]$href
  req = request(url)
  
  resp = resp_body_json(req_perform(req))
  print(url)
  
  # Print resource to txt file :
  sink(
    file = paste0(
      "C:/Users/Benjamin/Documents/GITHub/HDX_Proj-1/Logs/",
      namefile,
      ".txt"
    ),
    append = FALSE,
    type = c("output")
  )
  print(resp)
  sink()
  
 # Print resource as HTML : 
  if(html==TRUE){
    sink(
    file = paste0(
      "C:/Users/Benjamin/Documents/GITHub/HDX_Proj-1/HTML/",
      namefile,
      ".html"
    ),
    append = FALSE,
    type = c("output")
  )
  print(resp$data[[1]]$fields$`body-html`)
  sink()
  }
  
  # Save pdf file :
  if (pdf == TRUE) {
    req_perform(
      request(resp$data[[1]]$fields$file[[1]]$url),
      path = paste0(
        "C:/Users/Benjamin/Documents/GITHub/HDX_Proj-1/PDF/",
        namefile,
        ".pdf"
      )
    )
  }
  
  # sink(file = paste0("C:/Users/Benjamin/Documents/GITHub/HDX_Proj-1/Logs/",namefile,"_pdf.txt"), append = FALSE, type = c("output"))
  # if(pdf==TRUE){
  # library(pdftools)
  # pdftools::pdf_text(pdf = req$body)
  # }
  # sink()
  
  return(resp_body_json(req_perform(req)))
}
```

Main function :  

```{r Main, echo=TRUE}
# Perform a request that covers multi-arguments and operators :
Main <-
  function(endpoint = 1,
           limit = NULL,
           field = NULL,
           value = NULL,
           date.start = NULL,
           date.end = NULL,
           operator = NULL, 
           disaster = NULL) {
    
  # Ccall a request on the Relief Web aPI :
  req = req_call(endpoint)
  
  # LIMIT argument (if not given in arg. se limit in IF method) :
  
  if (is.null(limit) == TRUE | is.numeric(limit) == TRUE) {
    limit1 <-
      ifelse(is.null(limit) == TRUE,
             "&limit=100",
             paste0("&limit=", limit))
  } else{
    stop(
      "The argument 'limit' requires a NULL or numeric value.",
      call. = FALSE
    )
  }
  
  # In this version, VALUES and FIELDS are PAIRED :  MUST be  TWO VECTORS of the SAME SIZE : 
  # EXAMPLE : to search for two words in the same field (here "title"), see 
  # Main(...,field = c("title, "title"),value = c("word_1", "word_2"), )
  values = c()
  for(i in seq(1,length(value))){
    if(!is.null(field[i])){
      values = append(values, capture.output(cat("query[fields][]=",field[i],sep = "")))
    }
    if(!is.null(value[i])){
      values = append(values, capture.output(cat("query[value]=",value[i],sep = "")))
    }
  }
  # OPERATOR (given only once) : 
  if(!is.null(operator)){
      operator = capture.output(cat("query[operator]=",operator,sep = ""))
  }
  
  # DATE.START argument
  if (is.null(date.start) == TRUE |
      is.character(date.start) == TRUE) {
    date.start1 <- ifelse(
      is.null(date.start) == TRUE,
      "",
      paste0(
        "&filter[field]=date&filter[value][from]=",
        date.start,
        "T00:00:00%2B00:00"
      )
    )
  } else{
    stop(
      "The argument 'date.start' must be set to NULL (no restriction on sample start date) or
      requires a character string in the format 'yyyy-mm-dd'.",
      call. = FALSE
    )
  }
  
  # DATE.END argument
  if (is.null(date.end) == TRUE | is.character(date.end) == TRUE) {
    date.end1 <- ifelse(
      is.null(date.end) == TRUE,
      "",
      paste0(
        "&filter[field]=date&filter[value][to]=",
        date.end,
        "T00:00:00%2B00:00"
      )
    )
  } else{
    stop(
      "The argument 'date.end' must be set to NULL (no restriction on sample end date) or
      requires a character string in the format 'yyyy-mm-dd'.",
      call. = FALSE
    )
  }

   # disaster argument
  if(is.null(disaster)==TRUE |
     is.character(disaster)==TRUE) {
    disaster1 <- ifelse(is.null(disaster) == TRUE,
                        "",
                        paste0("query[value]=type:", paste(
                          gsub("\\s{1}", "%", disaster), collapse = "|"
                        )))
  } else{
    stop(
      "The argument 'disaster' requires a character vector of disaster types to be queried, or        is set to NULL.",
      call. = FALSE
    )
  }
  # Get RELIEFWEB - API-URL and add PARAMETEERS (Makes a "Kickstart"): 
    kickstart = paste0(req$url,limit1)
    kickstart = paste0(kickstart,date.start1)
    kickstart = paste0(kickstart,date.end1)
  # Add to the KICKSTART the [KEY WORDS ; FIELDS] for research 
  # RECALL : words and fields a to give by couple. Have to be presented as equaly sized VECTOR 
  if(!is.null(values)){
    # vectors are of the form : 
    # ["query[fields][]=.........." ; ""query[value]=.........."]
    temp = capture.output(cat(values,sep = "&"))
    temp = capture.output(cat(temp,operator,sep = "&"))
    temp = capture.output(cat(temp,disaster1,sep = "&"))
    temp = capture.output(cat("&",temp,sep = ""))
    temp = capture.output(cat(kickstart,temp,sep=""))
    # arranged in the form : [.................]
  }else{
    temp=kickstart
  }
    
  # Print URL for debugging :
  print(temp)
  
  # PERFORM REQUEST :
  request = request(temp)
  resp = req_perform(request)
  
  # JSON :
  res = resp_body_json(resp)
  
  # INFOS : 
  print("for :")
  print(res$href)
  print("had :")
  print(res$totalCount)
  print("got :")
  print(res$count)

  # SUMMARY (depending on types as ENDPOINT, due to different API structures ; see API) : 
  # Example :
  # - endpoint = 1 -> reports -> title
  # - endpoint = 2 -> disasters -> name
  print(res_summary(res,field = endpoint,lim = limit))
  
  # Return list of results :
  return(res)
}
```

For more informations on *"parameters"* for this API, you may want to loog the online documentation. The **3rd** function *summarize* the results in a sized list : 

##Examples :

```{r EXAMPLE_1, echo=TRUE}
endpoint = 2
value = c("Guinea")
field = c("name")
# operator = "AND"

# Simple request :
# res = Main(endpoint = endpoint,limit = 100,field = field,value = value,date.start = )
# With DATE START :
res = Main(endpoint = endpoint,limit = 10,field = field,value = value,disaster = "storm",date.start = "2020-01-02")
```


```{r EXAMPLE_2, echo=TRUE}
endpoint = 2
value = c("storm","hurrican")
field = c("name","name")
operator = "AND"

# Simple request :
# res = Main(endpoint = endpoint,limit = 100,field = field,value = value,date.start = )
# With DATE START :
res = Main(endpoint = endpoint,limit = 100,field = field,value = value,date.start = "2019-01-02",operator = operator)

# res = Main(endpoint = 6,limit = 10,field = c("name"),value = c("congo"))

```

```{r CASE, echo=TRUE}
# Forge request :
# res = Main(endpoint = 1,limit = 20, field = c("title","title"), value = c("gaza","health"),operator = "AND")

endpoint = 2
value = c("Guinea")
field = c("title")
operator = "AND"

# Simple request parameters :
# res = Main(endpoint = endpoint,limit = 100,field = field,value = value,date.start = )

res = Main(
  endpoint = 1,
  limit = 50,
  field = field,
  value = value,
  # disaster = "storm",
  date.start = "2020-01-02"
)

numero = 2

toto = PRINT_SEARCH(res = res,numero = numero,namefile = "test_1",pdf = TRUE,txt = FALSE,html = TRUE)

# PRINT_SEARCH = function(res,numero,namefile){
# # Menu results : 
# lapply(res$data,function(x){x$fields$name})
# # Request URL :
# url = res$data[[numero]]$href
# req = request(url)
# print(url)
# # Print resource information from RESQUEST to FILE :
# sink(file = paste0("C:/Users/Benjamin/Documents/GITHub/HDX_Proj-1/Logs/",namefile,".txt"), append = FALSE, type = c("output"))
# print(resp_body_json(req_perform(req)))
# sink()
# browseURL(url)
# }
#_______________________________________________________________________________
```